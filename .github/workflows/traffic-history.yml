name: traffic-history
on:
  schedule: [{ cron: "0 3 * * *" }]
  workflow_dispatch:
permissions:
  contents: write
jobs:
  fetch:
    runs-on: ubuntu-latest
    env:
      GH_HEADERS: >-
        -H "Accept: application/vnd.github+json"
        -H "X-GitHub-Api-Version: 2022-11-28"
        -H "Authorization: Bearer ${{ secrets.GH_TRAFFIC_TOKEN }}"
    steps:
      - uses: actions/checkout@v4
      - name: Derive OWNER/REPO
        id: repo
        run: |
          echo "OWNER=${GITHUB_REPOSITORY%/*}" >> $GITHUB_OUTPUT
          echo "REPO=${GITHUB_REPOSITORY#*/}"   >> $GITHUB_OUTPUT
      - run: mkdir -p .traffic
      - name: Fetch views
        run: |
          eval curl -s $GH_HEADERS https://api.github.com/repos/${{ steps.repo.outputs.OWNER }}/${{ steps.repo.outputs.REPO }}/traffic/views > .traffic/views_$(date +%F).json
      - name: Fetch clones
        run: |
          eval curl -s $GH_HEADERS https://api.github.com/repos/${{ steps.repo.outputs.OWNER }}/${{ steps.repo.outputs.REPO }}/traffic/clones > .traffic/clones_$(date +%F).json
      - name: Commit & push
        run: |
          git config user.name "gh-bot"
          git config user.email "bot@users.noreply.github.com"
          git add .traffic
          git commit -m "traffic: $(date -I)" || echo "Nada para commitear"
          git push
